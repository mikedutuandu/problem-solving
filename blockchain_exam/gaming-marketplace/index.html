<!DOCTYPE html>
<html>
<head>
    <title>Game Marketplace</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>
<h1>Game Marketplace</h1>
<button onclick="connectWallet()">Connect Wallet</button>
<div id="status"></div>

<script>
    // ABI - Copy this from Remix after compiling your contract
    const abi = [
        "function createItem(string name, uint8 itemType, uint256 power) external returns (uint256)",
        "function listItem(uint256 tokenId, uint256 price) external",
        "function buyItem(uint256 tokenId) external payable",
        "function items(uint256 tokenId) external view returns (tuple(string name, uint8 itemType, uint256 power, uint256 price))",
        "event ItemCreated(uint256 indexed tokenId, string name, uint8 itemType, uint256 power)",
        "event ItemListed(uint256 indexed tokenId, uint256 price)",
        "event ItemSold(uint256 indexed tokenId, address seller, address buyer, uint256 price)"
    ];

    class GameMarketplace {
        constructor() {
            this.contract = null;
            this.provider = null;
            this.signer = null;
        }

        async connect(contractAddress) {
            if (typeof window.ethereum === 'undefined') {
                throw new Error('Please install MetaMask!');
            }

            // Request account access
            await window.ethereum.request({ method: 'eth_requestAccounts' });

            this.provider = new ethers.providers.Web3Provider(window.ethereum);
            this.signer = this.provider.getSigner();

            this.contract = new ethers.Contract(
                contractAddress,
                abi,
                this.signer
            );

            // Setup event listeners
            this.setupEventListeners();

            return await this.signer.getAddress();
        }

        setupEventListeners() {
            this.contract.on('ItemCreated', (tokenId, name, itemType, power) => {
                console.log(`Item Created - ID: ${tokenId}, Name: ${name}`);
            });

            this.contract.on('ItemListed', (tokenId, price) => {
                console.log(`Item Listed - ID: ${tokenId}, Price: ${ethers.utils.formatEther(price)} ETH`);
            });

            this.contract.on('ItemSold', (tokenId, seller, buyer, price) => {
                console.log(`Item Sold - ID: ${tokenId}, Price: ${ethers.utils.formatEther(price)} ETH`);
            });
        }

        async createItem(name, itemType, power) {
            try {
                if (!this.contract) throw new Error('Not connected');

                const tx = await this.contract.createItem(name, itemType, power);
                const receipt = await tx.wait();

                const event = receipt.events.find(e => e.event === 'ItemCreated');
                return event.args.tokenId.toString();
            } catch (error) {
                console.error('Error creating item:', error);
                throw error;
            }
        }

        async listItem(tokenId, priceInEth) {
            try {
                if (!this.contract) throw new Error('Not connected');

                const price = ethers.utils.parseEther(priceInEth.toString());
                const tx = await this.contract.listItem(tokenId, price);
                await tx.wait();
            } catch (error) {
                console.error('Error listing item:', error);
                throw error;
            }
        }

        async buyItem(tokenId, priceInEth) {
            try {
                if (!this.contract) throw new Error('Not connected');

                const price = ethers.utils.parseEther(priceInEth.toString());
                const tx = await this.contract.buyItem(tokenId, { value: price });
                await tx.wait();
            } catch (error) {
                console.error('Error buying item:', error);
                throw error;
            }
        }

        async getItem(tokenId) {
            try {
                if (!this.contract) throw new Error('Not connected');

                const item = await this.contract.items(tokenId);
                return {
                    name: item.name,
                    itemType: item.itemType,
                    power: item.power.toString(),
                    price: ethers.utils.formatEther(item.price)
                };
            } catch (error) {
                console.error('Error getting item:', error);
                throw error;
            }
        }
    }

    // Global instance
    let marketplace;

    // Connect wallet function
    async function connectWallet() {
        try {
            marketplace = new GameMarketplace();
            const contractAddress = 'YOUR_CONTRACT_ADDRESS'; // Get this from Remix after deploying
            const address = await marketplace.connect(contractAddress);
            document.getElementById('status').innerHTML = `Connected: ${address}`;
        } catch (error) {
            document.getElementById('status').innerHTML = `Error: ${error.message}`;
        }
    }

    // Example usage functions
    async function testCreateItem() {
        try {
            const tokenId = await marketplace.createItem("Sword", 0, 100);
            console.log("Created item with ID:", tokenId);
            return tokenId;
        } catch (error) {
            console.error("Error:", error);
        }
    }

    async function testListItem(tokenId) {
        try {
            await marketplace.listItem(tokenId, "0.1");
            console.log("Item listed for 0.1 ETH");
        } catch (error) {
            console.error("Error:", error);
        }
    }

    async function testBuyItem(tokenId) {
        try {
            await marketplace.buyItem(tokenId, "0.1");
            console.log("Item purchased");
        } catch (error) {
            console.error("Error:", error);
        }
    }
</script>

<!-- Test Buttons -->
<div style="margin-top: 20px;">
    <button onclick="testCreateItem()">Create Test Item</button>
    <button onclick="testListItem(prompt('Enter token ID:'))">List Item</button>
    <button onclick="testBuyItem(prompt('Enter token ID:'))">Buy Item</button>
</div>
</body>
</html>